#!/usr/bin/env mocha

var fs = require('fs')
  , path = require('path')
  , preq = require('preq');

var assert = require('chai').assert;

require('dotenv').config();

var swaggestTest = require(path.join(__dirname, '/../lib/swaggest-test'));
var usageStr = "USAGE: flat-white [swagger.json]";

function fail() {
  describe('fail', function() {
    it(usageStr, function() {
      assert.equal(process.argv.length, 4);
    });
  });
};

function main() {
  if (process.argv.length !== 4) return fail();
  var swaggerFile = path.normalize(process.argv[3]);
  describe('testing your swagger api using ' + swaggerFile, function () {
    var spec = JSON.parse(fs.readFileSync(swaggerFile));
    var tests = swaggestTest.parse(spec, process.env);

    for (var route in tests) {
      for (var method in tests[route]) {
        var describeStr = 'Testing ' + method + ' ' + route;
        describe(describeStr, function () {
          tests[route][method].forEach(function (test) {
            it(test.description, function () {
              return preq(test.request)
              .then(function (response) {
                swaggestTest.assert(test.response, response);
              }, function (response) {
                swaggestTest.assert(test.response, response);
              });
            });
          });
        });
      }
    }
  });
}

main();
