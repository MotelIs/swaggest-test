#!/usr/bin/env mocha

var fs = require('fs')
  , path = require('path')
  , preq = require('preq');

var swaggestTest = require(__dirname + '/../lib/swaggest-test');
var usageStr = "USAGE: flat-white [swagger.json]";

function main() {
  if (process.argv.length !== 4) return console.log(usageStr);
  var swaggerFile = path.normalize(process.argv[3]);
  describe('testing your swagger api using ' + swaggerFile, function () {
		var spec = JSON.parse(fs.readFileSync(swaggerFile));
		var tests = swaggestTest.parse(spec);

		for (var route in tests) {
			for (var method in tests[route]) {
				var describeStr = 'Testing ' + method + ' ' + route;
				describe(describeStr, function () {
					tests[route][method].forEach(function (test) {
						it(test.description, function () {
							return preq[test.request.method]({
								uri: test.request.uri,
								query: test.request.query,
								body: test.request.body,
								headers: test.request.headers})
							.then(function (response) {
								swaggestTest.assert(test.response, response);
							}, function (response) {
								swaggestTest.assert(test.response, response);
							});
						});
					});
				});
			}
		}
  });
}

main();
